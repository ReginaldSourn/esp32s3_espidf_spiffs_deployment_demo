name: ESP32-S3 CI/CD Pipeline

# Add default permissions
permissions:
  contents: write  # Needed for creating releases

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*'  # Push events to matching v*, i.e. v1.0, v20.15.10
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allows manual triggering

env:
  FIRMWARE_VERSION: ${{ github.ref_name }}

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    container:
      image: ubuntu:24.04
      options: --privileged

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y \
          git \
          wget \
          flex \
          bison \
          gperf \
          python3 \
          python3-pip \
          python3-venv \
          python3-setuptools \
          python3-full \
          cmake \
          ninja-build \
          ccache \
          libffi-dev \
          libssl-dev \
          dfu-util \
          libusb-1.0-0 \
          usbutils \
          curl \
          jq

    - name: Set up ESP-IDF
      run: |
        mkdir -p /opt/esp
        cd /opt/esp
        
        # Clone ESP-IDF
        git clone --recursive https://github.com/espressif/esp-idf.git -b v5.3.1
        cd esp-idf
        
        # First, check what files are available (for debugging)
        echo "Checking ESP-IDF directory structure:"
        ls -la ./
        if [ -f "./requirements.txt" ]; then
          echo "requirements.txt found in root directory"
        fi
        
        if [ -d "./tools/requirements" ]; then
          echo "Found tools/requirements directory"
          ls -la ./tools/requirements/
        fi
        
        # Set up environment variables
        export IDF_PATH=/opt/esp/esp-idf
        export IDF_TOOLS_PATH=/opt/esp/tools
        
        # Create tools directory with correct permissions
        mkdir -p $IDF_TOOLS_PATH
        chmod -R 777 $IDF_TOOLS_PATH
        
        # Create and activate a Python virtual environment to avoid system package issues
        python3 -m venv /opt/esp/python_env
        source /opt/esp/python_env/bin/activate
        
        # Install required Python packages within the virtual environment
        pip install --upgrade pip
        
        # Let's use the proper ESP-IDF install script - it will handle all requirements
        echo "Running ESP-IDF install.sh script"
        chmod +x ./install.sh
        ./install.sh esp32s3
        
        # Create a script that will set up the environment correctly
        echo '#!/bin/bash' > /opt/esp/setup_env.sh
        echo 'export IDF_PATH=/opt/esp/esp-idf' >> /opt/esp/setup_env.sh
        echo 'export IDF_TOOLS_PATH=/opt/esp/tools' >> /opt/esp/setup_env.sh
        echo 'export IDF_TARGET=esp32s3' >> /opt/esp/setup_env.sh
        echo 'source /opt/esp/python_env/bin/activate' >> /opt/esp/setup_env.sh
        echo 'export PATH=$IDF_TOOLS_PATH/tools/xtensa-esp32s3-elf/esp-12.2.0_20230208/xtensa-esp32s3-elf/bin:$PATH' >> /opt/esp/setup_env.sh
        echo 'export PATH=$IDF_TOOLS_PATH/tools/riscv32-esp-elf/esp-12.2.0_20230208/riscv32-esp-elf/bin:$PATH' >> /opt/esp/setup_env.sh
        echo 'export PATH=$IDF_TOOLS_PATH/tools/esp32ulp-elf/2.35_20220830/esp32ulp-elf/bin:$PATH' >> /opt/esp/setup_env.sh
        echo 'export PATH=$IDF_PATH/tools:$PATH' >> /opt/esp/setup_env.sh
        
        # Make the setup script executable
        chmod +x /opt/esp/setup_env.sh
        
        # Verify installation
        ls -la $IDF_TOOLS_PATH

    - name: Set environment variables
      run: |
        echo "IDF_PATH=/opt/esp/esp-idf" >> $GITHUB_ENV
        echo "IDF_TARGET=esp32s3" >> $GITHUB_ENV
        echo "IDF_TOOLS_PATH=/opt/esp/tools" >> $GITHUB_ENV

    - name: Build project
      run: |
        # Source our environment setup script or manually set up the environment
        export IDF_PATH=/opt/esp/esp-idf
        export IDF_TARGET=esp32s3
        export IDF_TOOLS_PATH=/opt/esp/tools
        
        # Activate the Python virtual environment
        source /opt/esp/python_env/bin/activate
        
        # Source the ESP-IDF export script to set up path properly
        echo "Sourcing ESP-IDF export script"
        source $IDF_PATH/export.sh
        
        # Print environment for debugging
        echo "PATH = $PATH"
        echo "IDF_PATH = $IDF_PATH"
        echo "IDF_TOOLS_PATH = $IDF_TOOLS_PATH"
        echo "Python version:"
        python --version
        
        cd $GITHUB_WORKSPACE
        
        # Set the target explicitly
        echo "Setting target to ESP32-S3"
        idf.py set-target esp32s3
        
        # Build the project
        echo "Building the project"
        idf.py build

    - name: Run static code analysis
      run: |
        # Source ESP-IDF environment
        export IDF_PATH=/opt/esp/esp-idf
        export IDF_TARGET=esp32s3
        export IDF_TOOLS_PATH=/opt/esp/tools
        source /opt/esp/python_env/bin/activate
        source $IDF_PATH/export.sh
        
        # Example using cppcheck (you would need to install it first)
        # apt-get update && apt-get install -y cppcheck
        # cppcheck --enable=all --suppress=missingIncludeSystem main/

    - name: Run unit tests
      run: |
        # Source ESP-IDF environment
        export IDF_PATH=/opt/esp/esp-idf
        export IDF_TARGET=esp32s3
        export IDF_TOOLS_PATH=/opt/esp/tools
        source /opt/esp/python_env/bin/activate
        source $IDF_PATH/export.sh
        
        # Run tests if your project has them
        # idf.py test
        
        # Or use specific test commands if needed
        # For example:
        # python -m pytest test/

    - name: Create firmware package
      if: success()
      run: |
        # Source ESP-IDF environment
        export IDF_PATH=/opt/esp/esp-idf
        export IDF_TARGET=esp32s3
        export IDF_TOOLS_PATH=/opt/esp/tools
        source /opt/esp/python_env/bin/activate
        source $IDF_PATH/export.sh
        
        mkdir -p firmware-package
        cp build/bootloader/bootloader.bin firmware-package/
        cp build/*.bin firmware-package/
        cp build/*.elf firmware-package/
        cp build/*.map firmware-package/
        
        # Create version.txt with build info
        echo "Firmware version: ${FIRMWARE_VERSION:-dev}" > firmware-package/version.txt
        echo "Build date: $(date)" >> firmware-package/version.txt
        echo "Commit: ${{ github.sha }}" >> firmware-package/version.txt
        
        # Create a zip archive
        apt-get update && apt-get install -y zip
        zip -r esp32s3-firmware.zip firmware-package/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: esp32s3-firmware
        path: esp32s3-firmware.zip
        if-no-files-found: error

  deploy-development:
    needs: build
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
      
      - name: Deploy to development environment
        run: |
          echo "Deploying firmware to development server..."
          # Example: Upload to an FTP server or S3 bucket for development testing
          # This is a placeholder - implement the actual deployment method you need
          # aws s3 cp esp32s3-firmware.zip s3://your-dev-bucket/esp32s3/latest/
          echo "Deployed to development environment successfully"

  deploy-staging:
    needs: build
    if: github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
      
      - name: Deploy to staging environment
        run: |
          echo "Deploying firmware to staging server..."
          # Example: Upload to staging environment
          # This is a placeholder - implement the actual deployment method you need
          # aws s3 cp esp32s3-firmware.zip s3://your-staging-bucket/esp32s3/latest/
          echo "Deployed to staging environment successfully"

  deploy-production:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write  # This gives permission to create releases
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-firmware
      
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: esp32s3-firmware.zip
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy to production environment
        run: |
          echo "Deploying firmware to production server..."
          # Example: Upload to production environment
          # This is a placeholder - implement the actual deployment method you need
          # aws s3 cp esp32s3-firmware.zip s3://your-production-bucket/esp32s3/${{ github.ref_name }}/
          echo "Deployed to production environment successfully"